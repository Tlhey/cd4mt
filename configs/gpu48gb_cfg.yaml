data:
  target: DataLoader.multitrack_datamodule.DataModuleFromConfig
  params:
    batch_size: 10  # 48GB GPU 可以用较大 batch
    num_workers: 8   # 12 vCPU，用 8 个 worker

    augmentation:
      mixup: 0.0
      return_all_wav: false
      balanced_sampling: false

    path:
      dataset_type: "MultiSource_Slakh"
      train_data: dataset/slakh_44100/train
      valid_data: dataset/slakh_44100/validation
      test_data: dataset/slakh_44100/test
      stems: [bass, drums, guitar, piano]
      label_data: ""
      tempo_data: ""
      tempo_map: ""

    preprocessing:
      audio:
        sampling_rate: 44100
        segment_duration: 12.0
        normalize: true

model:
  cae:
    model_path: ""
    latent_dim: 64
    num_stems: 4
    stem_names: ["bass", "drums", "guitar", "piano"]

  diffusion:
    sigma_distribution:
      type: "LogNormal"
      mean: -1.2
      std: 1.2
    sigma_data: 1.2
    dynamic_threshold: 0.0
    loss_type: "mse"

  unet_1d:
    # 针对 48GB GPU 优化的参数
    base_channels: 320        # 从 256 提升到 320

    patch_blocks: 4
    patch_factor: 1
    kernel_sizes_init: [1, 3, 7]

    # 5层深度网络结构
    # len(multipliers) = len(factors)+1 = len(num_blocks)+1 = len(attentions)+1
    multipliers: [1, 2, 4, 6, 8]    # 增加深层通道容量
    factors:     [2, 2, 2, 2]       # 4次下采样
    num_blocks:  [2, 3, 4, 4]       # 深层更多blocks
    attentions:  [0, 0, 1, 1]       # 后两层使用attention

    attention_heads: 12              # 从 8 增加到 12
    attention_features: 64
    attention_multiplier: 2

    resnet_groups: 8
    kernel_multiplier_downsample: 2
    use_nearest_upsample: false
    use_skip_scale: true
    use_attention_bottleneck: true
    use_context_time: true

    training_mode: ""
    linear_probing: false
    time_emb_type: "LearnedPositional"

train:
  seed: 42
  precision: "fp16"               # 混合精度训练，节省显存

  # Batch 配置
  batch_size_per_gpu: 10          # 48GB 可以用 10
  grad_accum_steps: 1             # 如果 OOM，改为 2

  # 优化器
  lr: 1.0e-4
  betas: [0.9, 0.999]
  weight_decay: 0.0
  warmup_steps: 1000              # 添加 warmup

  # 训练步数
  max_steps: 100000
  log_every: 50
  save_every: 1000                # 每 1000 步保存一次
  eval_every: 500                 # 每 500 步评估一次
  grad_clip_norm: 1.0

  # 数据处理
  pad_to_factor_multiple: true
  pad_mode: "constant"
  pad_value: 0.0

  # 输出路径
  out_dir: "checkpoints/gpu48gb_run"
  resume_path: ""

  # 日志
  swanlab:
    project: "cd4mt-48gb"
    run_name: "unet320_bs10_fp16"
